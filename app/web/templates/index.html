<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tapo Camera Control</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"></script>
    <style>
        /* --- Layout & Theme --- */
        body {
            background: #181c24;
            color: #e0e0e0;
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            min-height: 100vh;
        }
        .header {
            background: #232837;
            padding: 24px 0 16px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
            color: #7ecfff;
        }
        .container {
            max-width: 700px;
            margin: 32px auto;
            background: #232837;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
            padding: 32px;
        }

        /* --- Video Feed --- */
        canvas#video-feed {
            width: 100%;
            height: auto;
            border-radius: 12px;
            background: #10131a;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }

        /* --- Status Labels --- */
        #motion-status {
            font-weight: 700;
            color: #fff;
            background: #e74c3c;
            text-align: center;
            padding: 10px;
            margin: 18px auto;
            border-radius: 8px;
            max-width: 400px;
            transition: background 0.3s;
        }
        #motion-status.active { background: #27ae60; }

        #recording-status {
            display: none; /* Hidden by default */
            margin-top: 18px;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            border-radius: 8px;
            color: #fff;
        }
        #recording-status.recording {
            background: #e74c3c;
            display: block;
            animation: pulse 1.2s infinite;
        }
        #recording-status.recorded {
            background: #27ae60;
            display: block;
        }

        /* --- Controls Section --- */
        .section-title {
            margin: 32px 0 12px 0;
            font-size: 1.3rem;
            color: #7ecfff;
            font-weight: 700;
            text-align: center;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .arrow-row {
            display: flex;
            gap: 12px;
        }
        
        /* --- Buttons --- */
        button {
            background: #222b3a;
            color: #7ecfff;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            user-select: none; /* Prevents text selection while holding */
        }
        button:active { transform: scale(0.95); }
        button:hover {
            background: #7ecfff;
            color: #181c24;
        }

        /* --- Links --- */
        .browse-link {
            display: block;
            text-align: center;
            color: #7ecfff;
            font-weight: 900;
            font-size: 1.2rem;
            text-decoration: none;
            margin: 20px 0;
        }
        .browse-link:hover { text-decoration: underline; }

        hr { border: 0; border-top: 1px solid #444; margin: 30px 0; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.7); }
            70% { box-shadow: 0 0 0 16px rgba(231,76,60,0); }
            100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Tapo Camera Stream</h1>
    </div>

    <div class="container">
        <canvas id="video-feed" width="1000" height="562"></canvas>

        <div class="controls" style="margin-top: 10px;">
            <button id="audio-toggle-btn" onclick="toggleAudio()" style="width: 100%; justify-content: center;">
                <span id="audio-icon">üîá</span> 
                <span id="audio-text" style="text-decoration: line-through; margin-left: 8px;">Audio</span>
            </button>
        </div>

        <div id="motion-status">No Motion Detected</div>

        <div class="section-title">Camera Controls</div>
        <div class="controls">
            <button class="ptz-btn" data-dir="up">‚ñ≤ Up</button>
            <div class="arrow-row">
                <button class="ptz-btn" data-dir="left">‚óÄ Left</button>
                <button class="ptz-btn" data-dir="right">Right ‚ñ∂</button>
            </div>
            <button class="ptz-btn" data-dir="down">‚ñº Down</button>
        </div>

        <hr>

        <a href="/recordings" class="browse-link">üìÅ Browse Recordings</a>
        
        <div style="display: flex; justify-content: center; gap: 15px;">
            <button onclick="startRecording()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7"/></svg>
                Start Rec
            </button>
            <button onclick="stopRecording()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><rect x="3" y="3" width="10" height="10" rx="2"/></svg>
                Stop Rec
            </button>
        </div>
        
        <div id="recording-status"></div>
    </div>

    <script>
        const socket = io();
        const canvas = document.getElementById('video-feed');
        const ctx = canvas.getContext('2d');
        const motionLabel = document.getElementById('motion-status');
        const recLabel = document.getElementById('recording-status');

        // --- Video Stream ---
        socket.on('video_frame', (data) => {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = 'data:image/jpeg;base64,' + data.frame;
        });

        // --- Audio Logic ---
        let audioCtx;
        let nextStartTime = 0;
        const audioBtn = document.getElementById('audio-toggle-btn');

        function toggleAudio() {
            // 1. Initialize Context if it doesn't exist
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }

            // 2. Toggle State (Running <-> Suspended)
            if (audioCtx.state === 'running') {
                audioCtx.suspend().then(() => updateAudioUI());
            } else {
                audioCtx.resume().then(() => updateAudioUI());
            }
        }

        function updateAudioUI() {
            const btn = document.getElementById('audio-toggle-btn');
            const icon = document.getElementById('audio-icon');
            const text = document.getElementById('audio-text');

            if (audioCtx && audioCtx.state === 'running') {
                // STATE: AUDIO IS ON (Normal Font)
                icon.innerHTML = "üîä";
                text.innerHTML = "Audio";
                text.style.textDecoration = "none";
                text.style.opacity = "1.0";
                
                // Optional: visual cue that it is active (e.g. slight highlight)
                btn.style.borderColor = "#7ecfff";
            } else {
                // STATE: AUDIO IS OFF (Crossed Out)
                icon.innerHTML = "üîá";
                text.innerHTML = "Audio";
                text.style.textDecoration = "line-through";
                text.style.opacity = "0.6"; // Dim it slightly to emphasize it is off
                
                btn.style.borderColor = "transparent";
            }
        }

        socket.on('audio_chunk', (arrayBuffer) => {
            // Only play if enabled
            if (!audioCtx || audioCtx.state !== 'running') return;

            // 1. Read as 16-bit Integers (Matches Python 's16')
            const int16Data = new Int16Array(arrayBuffer);
            
            // 2. Convert to Float32 (-1.0 to 1.0)
            const float32Data = new Float32Array(int16Data.length);
            for (let i = 0; i < int16Data.length; i++) {
                float32Data[i] = int16Data[i] / 32768.0;
            }

            // 3. Play it
            const audioBuffer = audioCtx.createBuffer(1, float32Data.length, 16000);
            audioBuffer.getChannelData(0).set(float32Data);
            
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);

            if (nextStartTime < audioCtx.currentTime) {
                nextStartTime = audioCtx.currentTime;
            }
            source.start(nextStartTime);
            nextStartTime += audioBuffer.duration;
        });

        // --- Motion Status ---
        socket.on('motion_status', (data) => {
            if (data.motion) {
                motionLabel.textContent = "Motion Detected!";
                motionLabel.classList.add('active');
            } else {
                motionLabel.textContent = "No Motion";
                motionLabel.classList.remove('active');
            }
        });

        // --- Recording Status ---
        socket.on('recording_status', (data) => {
            recLabel.className = ''; // Reset classes
            if (data.status === 'started') {
                recLabel.textContent = '‚óè Recording in Progress...';
                recLabel.classList.add('recording');
            } else if (data.status === 'stopped') {
                recLabel.textContent = '‚úì Video Saved';
                recLabel.classList.add('recorded');
                // Hide message after 3 seconds
                setTimeout(() => { recLabel.className = ''; recLabel.style.display='none'; }, 3000);
            }
        });

        function startRecording() { socket.emit('start_recording'); }
        function stopRecording() { socket.emit('stop_recording'); }

        // --- PTZ Logic (Press and Hold) ---
        let ptzInterval = null;
        const PTZ_DELAY = 100; // ms between commands

        function move(direction) {
            socket.emit('move_camera', { direction: direction, step: 2 });
        }

        function startMoving(direction) {
            if (ptzInterval) return;
            move(direction); // Move immediately
            ptzInterval = setInterval(() => move(direction), PTZ_DELAY); // Continue moving
        }

        function stopMoving() {
            if (ptzInterval) {
                clearInterval(ptzInterval);
                ptzInterval = null;
            }
        }

        // Attach listeners to all PTZ buttons
        document.querySelectorAll('.ptz-btn').forEach(btn => {
            const dir = btn.getAttribute('data-dir');
            
            // Mouse (Desktop)
            btn.addEventListener('mousedown', () => startMoving(dir));
            btn.addEventListener('mouseup', stopMoving);
            btn.addEventListener('mouseleave', stopMoving);

            // Touch (Mobile)
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); startMoving(dir); });
            btn.addEventListener('touchend', stopMoving);
        });

        // Keyboard Arrows
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return; // Prevent keyboard auto-repeat from interfering
            if (e.key === 'ArrowUp') startMoving('up');
            if (e.key === 'ArrowDown') startMoving('down');
            if (e.key === 'ArrowLeft') startMoving('left');
            if (e.key === 'ArrowRight') startMoving('right');
        });

        document.addEventListener('keyup', () => stopMoving());

    </script>
</body>
</html>